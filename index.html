<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRI Link Pro - Pemisah Ribuan</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 58mm; } }
        .thermal-font { font-family: 'Courier New', Courier, monospace; font-size: 12px; line-height: 1.2; }
        .locked-overlay { position: relative; }
        .locked-overlay::after { 
            content: "MENU TERKUNCI - SINKRONKAN SALDO AWAL DULU"; 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(255,255,255,0.9); display: flex; align-items: center; 
            justify-content: center; font-weight: bold; color: #1e40af; z-index: 50; 
            border-radius: 0.75rem; text-align: center; padding: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

<div id="app">
    <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center bg-blue-900 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-800 tracking-tighter">BRI Link Pro</h1>
                <p class="text-gray-500 italic">"Jadi Tau" Pembukuan Digital</p>
            </div>
            <div class="space-y-4">
                <input v-model="login.email" type="email" placeholder="Email" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 outline-none transition">
                <input v-model="login.pass" type="password" placeholder="Password" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 outline-none transition">
                <button @click="handleLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg">MASUK SISTEM</button>
            </div>
        </div>
    </div>

    <div v-else class="min-h-screen flex flex-col">
        <nav class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center text-center">
                <h1 class="font-bold text-lg md:text-xl">{{ config.namaToko }}</h1>
                <button @click="handleLogout" class="bg-red-500 hover:bg-red-600 px-4 py-1 rounded text-sm font-bold transition">Logout</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-b-4 border-blue-500">
                    <h2 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-widest">Monitor Real-time</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-end border-b pb-2">
                            <span class="text-gray-600 text-sm font-semibold">Laba Bersih</span>
                            <span class="text-2xl font-black text-green-600">Rp {{ formatUang(monitor.laba) }}</span>
                        </div>
                        <div class="flex justify-between items-end border-b pb-2">
                            <span class="text-gray-600 text-sm font-semibold">Total Hutang</span>
                            <span class="text-2xl font-black text-red-600">Rp {{ formatUang(monitor.hutang) }}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-widest">Saldo Berjalan</h2>
                    <div v-if="!sessionStarted" class="space-y-3">
                        <div v-for="(val, key) in saldoAwal" :key="key" class="flex items-center gap-2">
                            <label class="w-24 text-xs font-bold text-gray-500">{{ key }}</label>
                            <input :value="formatUang(saldoAwal[key])" @input="updateSaldo($event, key)" type="text" class="flex-1 border p-2 rounded bg-blue-50 focus:bg-white outline-none text-right font-bold">
                        </div>
                        <button @click="startSession" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg mt-4 shadow-md transition">MULAI SESI (BUKA GEMBOK)</button>
                    </div>
                    <div v-else class="grid grid-cols-2 gap-3">
                        <div v-for="(val, key) in saldoAwal" :key="key" class="bg-gray-50 p-2 rounded border text-center">
                            <p class="text-[10px] text-gray-400 font-bold uppercase">{{ key }}</p>
                            <p class="text-sm font-bold text-blue-800">{{ formatUang(val) }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="relative" :class="{ 'locked-overlay': !sessionStarted }">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="flex border-b bg-gray-50 text-sm font-bold text-center">
                            <button @click="tipe = 'transfer'" :class="tipe=='transfer'?'border-b-4 border-blue-600 text-blue-600 bg-white':'text-gray-400'" class="flex-1 py-4 uppercase">Transfer</button>
                            <button @click="tipe = 'pulsa'" :class="tipe=='pulsa'?'border-b-4 border-blue-600 text-blue-600 bg-white':'text-gray-400'" class="flex-1 py-4 uppercase">Pulsa/Token</button>
                            <button @click="tipe = 'wesel'" :class="tipe=='wesel'?'border-b-4 border-blue-600 text-blue-600 bg-white':'text-gray-400'" class="flex-1 py-4 uppercase">Wesel</button>
                        </div>

                        <div class="p-6 space-y-4">
                            <div v-if="tipe == 'transfer'" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-3">
                                    <label class="text-xs font-bold text-gray-400">SUMBER SALDO</label>
                                    <select v-model="form.rekening" class="w-full border-2 p-3 rounded-lg mt-1 outline-none">
                                        <option v-for="(v, k) in saldoAwal" v-if="k != 'Laci'" :key="k" :value="k">{{ k }}</option>
                                    </select>
                                </div>
                                <div><label class="text-[10px] font-bold">NOMINAL</label><input :value="formatUang(form.nominal)" @input="updateForm($event, 'nominal')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                                <div><label class="text-[10px] font-bold">ADMIN TOKO</label><input :value="formatUang(form.adminToko)" @input="updateForm($event, 'adminToko')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                                <div><label class="text-[10px] font-bold">POTONG BANK</label><input :value="formatUang(form.potonganBank)" @input="updateForm($event, 'potonganBank')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                            </div>

                            <div v-if="tipe == 'pulsa'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold">HARGA MODAL</label><input :value="formatUang(form.modal)" @input="updateForm($event, 'modal')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                                <div><label class="text-[10px] font-bold">HARGA JUAL</label><input :value="formatUang(form.jual)" @input="updateForm($event, 'jual')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                            </div>

                            <div v-if="tipe == 'wesel'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select v-model="form.jenisWesel" class="border-2 p-3 rounded-lg outline-none">
                                    <option value="kirim">Wesel Kirim (Laci+ / Bank-)</option>
                                    <option value="terima">Wesel Terima (Laci- / Bank+)</option>
                                </select>
                                <input v-model="form.kodeWesel" type="text" placeholder="Kode Referensi" class="border-2 p-3 rounded-lg">
                                <div><label class="text-[10px] font-bold">NOMINAL</label><input :value="formatUang(form.nominal)" @input="updateForm($event, 'nominal')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                                <div><label class="text-[10px] font-bold">ADMIN</label><input :value="formatUang(form.adminToko)" @input="updateForm($event, 'adminToko')" type="text" class="w-full border-2 p-3 rounded-lg text-right font-bold"></div>
                            </div>

                            <input v-model="form.nama" type="text" placeholder="Nama Pelanggan (Hutang wajib diisi)" class="w-full border-2 p-3 rounded-lg bg-gray-50 outline-none">

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 text-center">
                                <button @click="saveTransaksi('sukses')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">SIMPAN & CETAK LUNAS</button>
                                <button @click="saveTransaksi('hutang')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">SIMPAN & CETAK BON</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="sessionStarted" class="pt-6">
                    <button @click="uploadData" class="w-full bg-blue-800 hover:bg-black text-white py-5 rounded-xl font-black text-xl shadow-2xl transition">UPLOAD FIREBASE & TUTUP SESI</button>
                </div>
            </div>
        </div>

        <div id="print-area" class="hidden thermal-font">
            <div style="text-align: center; width: 58mm; padding: 10px;">
                <p style="font-weight: bold; font-size: 14px;">{{ config.namaToko }}</p>
                <p>{{ config.alamat }}</p>
                <p>----------------------------</p>
                <div v-if="printData" style="text-align: left;">
                    <p>Tgl   : {{ printData.waktu }}</p>
                    <p>Tipe  : {{ printData.tipe.toUpperCase() }}</p>
                    <p>Nama  : {{ printData.nama }}</p>
                    <p>Total : Rp {{ formatUang(printData.total) }}</p>
                    <p>Status: {{ printData.status.toUpperCase() }}</p>
                    <p v-if="printData.kode">REF   : {{ printData.kode }}</p>
                </div>
                <p>----------------------------</p>
                <p>Terima kasih</p>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4MsTF08I2zXqX6IimdATSGRFl0GV3WyQ",
  authDomain: "newbrilink-ac715.firebaseapp.com",
  projectId: "newbrilink-ac715",
  databaseURL: "https://newbrilink-ac715-default-rtdb.asia-southeast1.firebasedatabase.app",
  storageBucket: "newbrilink-ac715.firebasestorage.app",
  messagingSenderId: "58744983481",
  appId: "1:58744983481:web:a48eb7837acb4ce7ec7068",
  measurementId: "G-6850ZPV20M"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

new Vue({
    el: '#app',
    data: {
        isLoggedIn: false,
        sessionStarted: false,
        tipe: 'transfer',
        login: { email: '', pass: '' },
        config: { namaToko: 'AGEN BRI LINK BAROKAH', alamat: 'Jl. Jadi Tau No. 1' },
        saldoAwal: { BRI: 0, Mandiri: 0, Dana: 0, Digipos: 0, Pulsa: 0, Laci: 0 },
        form: { rekening: 'BRI', nominal: 0, adminToko: 0, potonganBank: 0, modal: 0, jual: 0, nama: 'Umum', jenisWesel: 'kirim', kodeWesel: '' },
        monitor: { laba: 0, hutang: 0 },
        transaksiList: [],
        printData: null
    },
    methods: {
        formatUang(val) {
            return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        },
        parseUang(val) {
            return parseInt(val.replace(/\./g, '')) || 0;
        },
        updateSaldo(event, key) {
            this.saldoAwal[key] = this.parseUang(event.target.value);
        },
        updateForm(event, field) {
            this.form[field] = this.parseUang(event.target.value);
        },
        handleLogin() {
            auth.signInWithEmailAndPassword(this.login.email, this.login.pass)
                .then(() => { this.isLoggedIn = true; })
                .catch(err => alert("Gagal Login: " + err.message));
        },
        handleLogout() { auth.signOut().then(() => { location.reload(); }); },
        startSession() { 
            if(this.saldoAwal.Laci <= 0) return alert("Isi saldo laci dulu!"); 
            this.sessionStarted = true; 
        },
        saveTransaksi(status) {
            let laba = 0, total = 0;
            if(this.tipe == 'transfer'){
                laba = this.form.adminToko - this.form.potonganBank;
                total = this.form.nominal + this.form.adminToko;
                if(status == 'sukses'){ this.saldoAwal[this.form.rekening] -= (this.form.nominal + this.form.potonganBank); this.saldoAwal.Laci += total; }
            } else if(this.tipe == 'pulsa'){
                laba = this.form.jual - this.form.modal;
                total = this.form.jual;
                if(status == 'sukses'){ this.saldoAwal.Pulsa -= this.form.modal; this.saldoAwal.Laci += total; }
            } else if(this.tipe == 'wesel'){
                laba = this.form.adminToko; total = this.form.nominal + this.form.adminToko;
                if(status == 'sukses'){ 
                    if(this.form.jenisWesel == 'kirim'){ this.saldoAwal.Laci += total; this.saldoAwal.BRI -= this.form.nominal; }
                    else { this.saldoAwal.Laci -= this.form.nominal; this.saldoAwal.BRI += this.form.nominal; }
                }
            }
            const item = { waktu: new Date().toLocaleTimeString(), tipe: this.tipe, nama: this.form.nama, total, status, kode: this.form.kodeWesel, laba };
            this.transaksiList.push(item);
            this.monitor.laba += laba;
            if(status == 'hutang') this.monitor.hutang += total;
            this.printData = item;
            setTimeout(() => { window.print(); }, 500);
            this.resetForm();
        },
        resetForm() { this.form.nominal = 0; this.form.adminToko = 0; this.form.nama = 'Umum'; this.form.kodeWesel = ''; this.form.modal = 0; this.form.jual = 0; this.form.potonganBank = 0; },
        uploadData() {
            if(!confirm("Tutup sesi & upload ke Firebase?")) return;
            db.ref('laporan/' + Date.now()).set({ 
                saldoAwal: this.saldoAwal, 
                transaksi: this.transaksiList, 
                totalLaba: this.monitor.laba, 
                tanggal: new Date().toLocaleDateString() 
            })
            .then(() => { alert("Sinkronisasi Berhasil!"); location.reload(); });
        }
    }
});
</script>
</body>
</html>
